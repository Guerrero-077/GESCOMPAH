<mat-horizontal-stepper [linear]="true" #stepper class="form-stepper">

  <!-- Paso 1: Datos del establecimiento -->
  <mat-step [stepControl]="generalGroup">
    <form [formGroup]="generalGroup" autocomplete="off" spellcheck="false" class="form-step">
      <ng-template matStepLabel>Datos del Local</ng-template>

      <div class="section-header">
        <h3>Información Básica del Local</h3>
      </div>

      <!-- Grid responsivo -->
      <div class="form-grid">
        <!-- Nombre -->
        <div class="field-with-error col-span-2">
        <mat-form-field appearance="outline">
          <mat-label>Nombre</mat-label>
          <input
            matInput
            formControlName="name"
            required
            placeholder="Local 15 - Carnicería El Buen Sabor"
            (blur)="onTrim(generalGroup.get('name'))"
            autocomplete="off"
          />
          <mat-hint align="start">{{ generalGroup.get('name')?.value?.length || 0 }}/100</mat-hint>
        </mat-form-field>
        <app-form-error [control]="generalGroup.get('name')" label="Nombre" variant="plain"></app-form-error>
        </div>

        <!-- Área -->
        <div class="field-with-error">
        <mat-form-field appearance="outline">
          <mat-label>Área (m²)</mat-label>
          <input
            matInput
            type="number"
            appNoSci
            inputmode="decimal"
            step="0.01"
            min="1"
            formControlName="areaM2"
            required
            placeholder="25.50"
            (blur)="onNumberBlur(generalGroup.get('areaM2'))"
            autocomplete="off"
          />
        </mat-form-field>
        <app-form-error [control]="generalGroup.get('areaM2')" label="Área (m²)" variant="plain"></app-form-error>
        </div>

        

        <!-- UVT -->
        <div class="field-with-error">
        <mat-form-field appearance="outline">
          <mat-label>UVT</mat-label>
          <input
            matInput
            type="number"
            appNoSci
            inputmode="decimal"
            step="0.01"
            min="1"
            formControlName="uvtQty"
            required
            placeholder="2.5"
            (blur)="onNumberBlur(generalGroup.get('uvtQty'))"
            autocomplete="off"
          />
        </mat-form-field>
        <app-form-error [control]="generalGroup.get('uvtQty')" label="UVT" variant="plain"></app-form-error>
        </div>
      </div>

      <!-- Descripción -->
      <div class="field-with-error mt-2 w-100">
      <mat-form-field appearance="outline">
        <mat-label>Descripción</mat-label>
        <textarea
          matInput
          rows="3"
          formControlName="description"
          required
          placeholder="Local comercial ubicado en el primer piso..."
          (blur)="onTrim(generalGroup.get('description'))"
        ></textarea>
        <mat-hint align="start">{{ generalGroup.get('description')?.value?.length || 0 }}/500</mat-hint>
      </mat-form-field>
      <app-form-error [control]="generalGroup.get('description')" label="Descripción" variant="plain"></app-form-error>
      </div>

      <div class="form-actions">
        <app-standard-button text="Cancelar" variant="stroked" (clicked)="cancel()" [disabled]="isBusy"></app-standard-button>
        <app-standard-button
          text="Siguiente"
          variant="raised"
          color="primary"
          icon="arrow_forward"
          iconPosition="right"
          (clicked)="stepper.next()"
          [disabled]="generalGroup.invalid || isBusy">
        </app-standard-button>
      </div>
    </form>
  </mat-step>

  <!-- Paso 2: Ubicación -->
  <mat-step [stepControl]="ubicacionGroup">
    <form [formGroup]="ubicacionGroup" autocomplete="off" spellcheck="false" class="form-step">
      <ng-template matStepLabel>Ubicación</ng-template>

      <div class="section-header">
        <h3>Ubicación del Local</h3>
      </div>

      <!-- Plaza -->
      <div class="field-with-error w-100 mb-3">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Plaza*</mat-label>
        <mat-select formControlName="plazaId" required>
          <mat-option *ngFor="let plaza of Squares; trackBy: trackByIndex" [value]="plaza.id">
            {{ plaza.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <app-form-error [control]="ubicacionGroup.get('plazaId')" label="Plaza" variant="plain"></app-form-error>
      </div>

      <!-- Dirección -->
      <div class="field-with-error w-100 mb-3">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Dirección</mat-label>
        <input
          matInput
          formControlName="address"
          placeholder="Carrera 7 # 14 - 28 Local 15"
          (blur)="onTrim(ubicacionGroup.get('address'))"
          autocomplete="off"
        />
      </mat-form-field>
      <app-form-error [control]="ubicacionGroup.get('address')" label="Dirección" variant="plain"></app-form-error>
      </div>

      <div class="form-actions space-between">
        <div>
          <app-standard-button text="Cancelar" variant="stroked" (clicked)="cancel()" [disabled]="isBusy"></app-standard-button>
          <app-standard-button
            text="Anterior"
            variant="flat"
            icon="arrow_back"
            iconPosition="left"
            (clicked)="stepper.previous()"
            [disabled]="isBusy">
          </app-standard-button>
        </div>
        <app-standard-button
          text="Siguiente"
          variant="raised"
          color="primary"
          icon="arrow_forward"
          iconPosition="right"
          (clicked)="stepper.next()"
          [disabled]="ubicacionGroup.invalid || isBusy">
        </app-standard-button>
      </div>
    </form>
  </mat-step>

  <!-- Paso 3: Imágenes -->
  <mat-step>
    <ng-template matStepLabel>Imágenes</ng-template>
    <div class="form-step">

      <div class="section-header">
        <h3>Imágenes del Local</h3>
      </div>

      <!-- Dropzone -->
      <div
        appFileDrop
        (files)="onFilesAdded($event)"
        class="dropzone mb-3"
        [class.dropzone--disabled]="isBusy"
        role="button"
        tabindex="0"
        (keydown.enter)="fileInput.click()"
        (keydown.space)="fileInput.click()"
        (click)="fileInput.click()"
      >
        <mat-icon>cloud_upload</mat-icon>
        <p>Arrastra imágenes aquí o haz clic para seleccionarlas</p>
        <small>Formatos soportados: JPG, PNG, WEBP (Máx. {{ MAX_IMAGES }} imágenes · {{ MAX_FILE_SIZE_MB }} MB c/u)</small>
        <input type="file" #fileInput (change)="handleFileInput($event)" accept="image/jpeg,image/png,image/webp" multiple hidden />
      </div>

      <div class="image-counter mt-2 mb-3">
        <span class="counter-badge">
          {{ selectedFiles.length + existingImagesFull.length }}/{{ MAX_IMAGES }} imágenes
        </span>
      </div>

      <div class="compact-image-grid">
        <!-- Existentes -->
        <div
          class="compact-image-container"
          *ngFor="let img of existingImagesFull; let i = index; trackBy: trackByIndex"
          (dragstart)="$event.preventDefault()"
          (click)="openPreviewFromExisting(i)"
          role="button"
          tabindex="0"
          (keydown.enter)="openPreviewFromExisting(i)"
          (keydown.space)="openPreviewFromExisting(i)"
        >
          <img [src]="imgSrc(img)" alt="Imagen existente" class="compact-image" draggable="false" />
          <div class="compact-image-actions">
            <button
              mat-icon-button
              color="warn"
              (click)="$event.stopPropagation(); removeImage(i, true)"
              matTooltip="Eliminar"
              [disabled]="isBusy"
            >
              <mat-icon class="compact-icon">delete</mat-icon>
            </button>
          </div>
          <span class="compact-image-label">Existente</span>
        </div>

        <!-- Nuevas -->
        <div
          class="compact-image-container"
          *ngFor="let imgPath of imagesPreview; let i = index; trackBy: trackByIndex"
          (dragstart)="$event.preventDefault()"
          (click)="openPreviewFromNew(i)"
          role="button"
          tabindex="0"
          (keydown.enter)="openPreviewFromNew(i)"
          (keydown.space)="openPreviewFromNew(i)"
        >
          <img [src]="imgPath" alt="Vista previa" class="compact-image" draggable="false" />
          <div class="compact-image-actions">
            <button
              mat-icon-button
              color="warn"
              (click)="$event.stopPropagation(); removeImage(i, false)"
              matTooltip="Eliminar"
              [disabled]="isBusy"
            >
              <mat-icon class="compact-icon">delete</mat-icon>
            </button>
          </div>
          <span class="compact-image-label">Nueva</span>
        </div>
      </div>

      <div class="form-actions space-between">
        <div>
          <app-standard-button text="Cancelar" variant="stroked" (clicked)="cancel()" [disabled]="isBusy"></app-standard-button>
          <app-standard-button
            text="Anterior"
            variant="flat"
            icon="arrow_back"
            iconPosition="left"
            (clicked)="stepper.previous()"
            [disabled]="isBusy">
          </app-standard-button>
        </div>
        <app-standard-button
          [text]="isEdit ? 'Guardar cambios' : 'Guardar'"
          variant="raised"
          color="primary"
          icon="save"
          iconPosition="left"
          (clicked)="onSubmit()"
          [disabled]="generalGroup.invalid || ubicacionGroup.invalid || isBusy">
        </app-standard-button>
      </div>
    </div>
  </mat-step>
</mat-horizontal-stepper>
