<div class="container">
  <mat-horizontal-stepper class="card shadow p-4" [linear]="true">
    <!-- PASO 1: UBICACIÓN -->
    <mat-step [stepControl]="locationGroup">
      <form [formGroup]="locationGroup">
        <ng-template matStepLabel>Ubicación</ng-template>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Departamento</mat-label>
          <mat-select formControlName="departmentId" required [compareWith]="compareById">
            <mat-option *ngFor="let d of (departments$ | async) ?? []" [value]="d.id">
              {{ d.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="locationGroup.get('departmentId')?.hasError('required')">
            Selecciona un departamento
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Ciudad</mat-label>
          <mat-select formControlName="cityId" required [compareWith]="compareById">
            <mat-option [value]="null" disabled>Selecciona una ciudad…</mat-option>

            <mat-option
              *ngIf="locationGroup.get('departmentId')?.value && !loadingCities && (((cities$ | async)?.length ?? 0) === 0)"
              [disabled]="true">
              No hay ciudades disponibles para este departamento
            </mat-option>

            <mat-option *ngFor="let c of (cities$ | async) ?? []" [value]="c.id">
              {{ c.name }}
            </mat-option>
          </mat-select>

          <mat-icon *ngIf="loadingCities" matSuffix class="spin">autorenew</mat-icon>

          <mat-error *ngIf="locationGroup.get('cityId')?.errors as errs">
            {{
              getFirstError(locationGroup.get('cityId'), ['required','min'])
              || 'Selecciona una ciudad válida'
            }}
          </mat-error>
        </mat-form-field>

        <div class="step-actions">
          <button mat-stroked-button type="button" (click)="cancel()">Cancelar</button>
          <button mat-raised-button color="primary" matStepperNext [disabled]="locationGroup.invalid">
            Siguiente
          </button>
        </div>
      </form>
    </mat-step>

    <!-- PASO 2: PERSONA -->
    <mat-step [stepControl]="personGroup">
      <form [formGroup]="personGroup">
        <ng-template matStepLabel>Datos personales</ng-template>

        <div class="grid">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Nombres</mat-label>
            <input
              matInput
              formControlName="firstName"
              required
              placeholder="Jhon"
              maxlength="50"
              (blur)="personGroup.get('firstName')?.updateValueAndValidity()" />
            <mat-error *ngIf="personGroup.get('firstName')?.errors as errs">
              {{
                getFirstError(personGroup.get('firstName'), ['required','onlySpaces','alphaHuman','maxlength'])
              }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Apellidos</mat-label>
            <input
              matInput
              formControlName="lastName"
              required
              placeholder="Doe"
              maxlength="50"
              (blur)="personGroup.get('lastName')?.updateValueAndValidity()" />
            <mat-error *ngIf="personGroup.get('lastName')?.errors as errs">
              {{
                getFirstError(personGroup.get('lastName'), ['required','onlySpaces','alphaHuman','maxlength'])
              }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="grid">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Documento</mat-label>
            <input matInput formControlName="document" required placeholder="1234567890" maxlength="10" />
            <mat-hint>7 a 10 dígitos</mat-hint>
            <mat-error *ngIf="personGroup.get('document')?.errors as errs">
              {{
                getFirstError(personGroup.get('document'), ['required','colombianDocument'])
              }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Teléfono</mat-label>
            <span matPrefix>+57&nbsp;</span>
            <input matInput formControlName="phone" required placeholder="3001234567" maxlength="10" />
            <mat-hint>Celular de 10 dígitos (ej. 3001234567)</mat-hint>
            <mat-error *ngIf="personGroup.get('phone')?.errors as errs">
              {{
                getFirstError(personGroup.get('phone'), ['required','colombianPhone'])
              }}
            </mat-error>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Dirección</mat-label>
          <input
            matInput
            formControlName="address"
            required
            placeholder="Carrera 5 # 15 - 25"
            maxlength="100"
            (blur)="personGroup.get('address')?.updateValueAndValidity()" />
          <mat-error *ngIf="personGroup.get('address')?.errors as errs">
            {{
              getFirstError(personGroup.get('address'), ['required','onlySpaces','maxlength'])
            }}
          </mat-error>
        </mat-form-field>

        <div class="step-actions">
          <button mat-stroked-button type="button" (click)="cancel()">Cancelar</button>
          <button mat-button matStepperPrevious>Volver</button>
          <button mat-raised-button color="primary" matStepperNext [disabled]="personGroup.invalid">
            Siguiente
          </button>
        </div>
      </form>
    </mat-step>

    <!-- PASO 3: CUENTA y ROL -->
    <mat-step [stepControl]="accountGroup">
      <form [formGroup]="accountGroup">
        <ng-template matStepLabel>Cuenta</ng-template>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Correo</mat-label>
          <input
            matInput
            type="email"
            formControlName="email"
            required
            placeholder="usuario@example.com"
            (blur)="fixEmail()" />
          <mat-error *ngIf="accountGroup.get('email')?.errors as errs">
            {{
              getFirstError(accountGroup.get('email'),
                ['required','email','domainMissing','tldMissing','tldInvalid','domainInvalid']
              )
            }}
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Rol</mat-label>
          <mat-select [formControl]="roleIdCtrl" required [compareWith]="compareById">
            <mat-option [value]="null" disabled>Selecciona un rol…</mat-option>
            <mat-option *ngFor="let r of (roles$ | async) ?? []" [value]="r.id">
              {{ r.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="roleIdCtrl.errors as errs">
            {{ getFirstError(roleIdCtrl, ['required','min']) || 'Selecciona un rol' }}
          </mat-error>
        </mat-form-field>

        <div class="step-actions">
          <button mat-stroked-button type="button" (click)="cancel()">Cancelar</button>
          <button mat-button matStepperPrevious>Volver</button>
          <button
            mat-raised-button
            color="primary"
            (click)="submit()"
            [disabled]="form.invalid || isLoading">
            {{ isLoading ? 'Guardando...' : (isEdit ? 'Actualizar' : 'Crear') }}
          </button>
        </div>
      </form>
    </mat-step>
  </mat-horizontal-stepper>
</div>
