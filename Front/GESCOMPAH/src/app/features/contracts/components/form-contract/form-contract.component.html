<mat-stepper linear #stepper>
  <!-- Step 1: Person Information -->
  <mat-step [stepControl]="personFormGroup">
    <form [formGroup]="personFormGroup" class="form">
      <ng-template matStepLabel>
        {{ stepper.selectedIndex === 0 ? 'Información del Arrendatario' : 'Información...' }}
      </ng-template>

      <div class="section-header">
        <h3>Datos de Identificación</h3>
      </div>

      <!-- Documento -->
      <div class="row">
        <mat-form-field appearance="outline" class="field">
          <mat-label>Documento de Identidad</mat-label>
          <input
            matInput
            appDocumentFormat
            class="document-digit-input"
            formControlName="document"
            placeholder="1.234.567"
            maxlength="14"
            inputmode="numeric"
            required
            (keydown.enter)="personFormGroup.get('document')!.markAsTouched(); personFormGroup.get('document')!.updateValueAndValidity();"
          />

          <mat-spinner *ngIf="loadingPerson" matSuffix diameter="20"></mat-spinner>
          <mat-error *ngIf="personFormGroup.get('document')?.hasError('required')">Por favor ingrese el número de documento de identidad</mat-error>
          <mat-error *ngIf="personFormGroup.get('document')?.hasError('colombianDocument')">
            El documento debe tener entre 7 y 10 dígitos numéricos
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Datos persona -->
      <div class="row two-cols">
        <!-- Nombres -->
        <mat-form-field appearance="outline" class="field no-dim">
          <mat-label>Nombres</mat-label>
          <input matInput formControlName="firstName" placeholder="Carlos Alberto" />
          <mat-error *ngIf="personFormGroup.get('firstName')?.hasError('required')">Por favor ingrese los nombres del arrendatario</mat-error>
          <mat-error *ngIf="personFormGroup.get('firstName')?.hasError('onlySpaces')">Los nombres no pueden estar vacíos o contener solo espacios</mat-error>
          <mat-error *ngIf="personFormGroup.get('firstName')?.hasError('alphaHuman')">Los nombres solo pueden contener letras y espacios</mat-error>
        </mat-form-field>

        <!-- Apellidos  -->
        <mat-form-field appearance="outline" class="field no-dim">
          <mat-label>Apellidos</mat-label>
          <input matInput formControlName="lastName" placeholder="García Rodríguez" />
          <mat-error *ngIf="personFormGroup.get('lastName')?.hasError('required')">Por favor ingrese los apellidos del arrendatario</mat-error>
          <mat-error *ngIf="personFormGroup.get('lastName')?.hasError('onlySpaces')">Los apellidos no pueden estar vacíos o contener solo espacios</mat-error>
          <mat-error *ngIf="personFormGroup.get('lastName')?.hasError('alphaHuman')">Los apellidos solo pueden contener letras y espacios</mat-error>
        </mat-form-field>
      </div>

      <div class="section-header">
        <h3>Información de Contacto</h3>
      </div>

      <div class="row two-cols">
        <!-- Teléfono -->
        <mat-form-field appearance="outline" class="field no-dim">
          <mat-label>Teléfono Celular</mat-label>
          <input matInput formControlName="phone" placeholder="3012345678" />
          <mat-hint>Número celular colombiano de 10 dígitos</mat-hint>
          <mat-error *ngIf="personFormGroup.get('phone')?.hasError('required')">Por favor ingrese el número de teléfono celular</mat-error>
          <mat-error *ngIf="personFormGroup.get('phone')?.hasError('colombianPhone')">Ingrese un número celular válido (debe empezar en 3 y tener 10 dígitos)</mat-error>
        </mat-form-field>

        <!-- Email -->
        <mat-form-field appearance="outline" class="field no-dim">
          <mat-label>Correo Electrónico</mat-label>
          <input matInput type="email" formControlName="email" required placeholder="carlos.garcia@gmail.com"
            (blur)="fixEmail()" />
          <mat-hint>Se enviará el contrato a este correo</mat-hint>
          <mat-error *ngIf="personFormGroup.get('email')?.errors as errs">
            {{
            getFirstError(personFormGroup.get('email'),
            ['required','email','domainMissing','tldMissing','tldInvalid','domainInvalid']
            )
            }}
          </mat-error>
        </mat-form-field>
      </div>

      <div class="actions">
        <app-standard-button
          text="Cancelar"
          variant="stroked"
          (clicked)="cancel()">
        </app-standard-button>
        <app-standard-button
          text="Siguiente"
          variant="raised"
          color="primary"
          icon="arrow_forward"
          iconPosition="right"
          (clicked)="stepper.next()">
        </app-standard-button>
      </div>
    </form>
  </mat-step>

  <!-- Step 2: Contract Details -->
  <mat-step [stepControl]="contractFormGroup">
    <form [formGroup]="contractFormGroup" class="form">
      <ng-template matStepLabel>
        {{ stepper.selectedIndex === 1 ? 'Detalles del Contrato' : 'Detalles...' }}
      </ng-template>

      <div class="section-header">
        <h3>Información de Residencia</h3>
      </div>

      <!-- Ubicación -->
      <div class="row two-cols">
        <!-- Dirección -->
        <mat-form-field appearance="outline" class="field no-dim">
          <mat-label>Dirección de Residencia</mat-label>
          <input matInput formControlName="address" placeholder="Calle 26 # 47 - 15 Apto 302" />
          <mat-hint>Dirección completa donde reside el arrendatario</mat-hint>
          <mat-error *ngIf="contractFormGroup.get('address')?.hasError('required')">Por favor ingrese la dirección completa de residencia</mat-error>
          <mat-error *ngIf="contractFormGroup.get('address')?.hasError('addressInvalid')">
            La dirección solo puede contener letras, números, espacios y los símbolos # - , .
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="field no-dim">
          <mat-label>Ciudad de Residencia</mat-label>
          <mat-select formControlName="cityId">
            <mat-option *ngFor="let c of ciudades" [value]="c.id">{{ c.name }}</mat-option>
          </mat-select>
          <mat-hint *ngIf="personaEncontrada && foundCityName">Ciudad encontrada: {{ foundCityName }}</mat-hint>
          <mat-error *ngIf="contractFormGroup.get('cityId')?.hasError('required')">Por favor seleccione la ciudad donde reside el arrendatario</mat-error>
        </mat-form-field>
      </div>

      <div class="section-header">
        <h3>Período del Contrato</h3>
      </div>

      <!-- Fechas del Contrato -->
      <div class="row two-cols">
        <mat-form-field appearance="outline" class="field no-dim">
          <mat-label>Fecha de Inicio del Contrato</mat-label>
          <input matInput [matDatepicker]="pickerStart" formControlName="startDate" [min]="startMinDate" readonly />
          <button mat-icon-button matSuffix type="button" (click)="pickerStart.open()"
            aria-label="Abrir calendario de inicio">
            <mat-icon>event</mat-icon>
          </button>
          <mat-datepicker #pickerStart></mat-datepicker>
          <mat-hint>Fecha en que inicia la vigencia del contrato</mat-hint>
          <mat-error *ngIf="contractFormGroup.get('startDate')?.hasError('required')">Por favor seleccione la fecha de inicio del contrato de arrendamiento</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="field">
          <mat-label>Fecha de Finalización del Contrato</mat-label>
          <input matInput [matDatepicker]="pickerEnd" formControlName="endDate" [min]="minEndDate" />
          <button mat-icon-button matSuffix type="button" (click)="pickerEnd.open()"
            aria-label="Abrir calendario de fin">
            <mat-icon>event</mat-icon>
          </button>
          <mat-datepicker #pickerEnd></mat-datepicker>
          <mat-hint>Fecha en que termina la vigencia del contrato</mat-hint>
          <mat-error *ngIf="contractFormGroup.hasError('endBeforeStart')">
            La fecha de finalización debe ser posterior a la fecha de inicio
          </mat-error>
          <mat-error *ngIf="contractFormGroup.get('endDate')?.hasError('required')">Por favor seleccione la fecha de finalización del contrato de arrendamiento</mat-error>
        </mat-form-field>
      </div>

      <div class="actions">
        <app-standard-button
          text="Cancelar"
          variant="stroked"
          (clicked)="cancel()">
        </app-standard-button>
        <app-standard-button
          text="Atrás"
          variant="flat"
          icon="arrow_back"
          (clicked)="stepper.previous()">
        </app-standard-button>
        <app-standard-button
          text="Siguiente"
          variant="raised"
          color="primary"
          icon="arrow_forward"
          iconPosition="right"
          (clicked)="stepper.next()">
        </app-standard-button>
      </div>
    </form>
  </mat-step>

  <!-- Step 3: Establishments -->
  <mat-step [stepControl]="establishmentFormGroup">
    <form [formGroup]="establishmentFormGroup" class="form">
      <ng-template matStepLabel>
        {{ stepper.selectedIndex === 2 ? 'Establecimientos' : 'Establec...' }}
      </ng-template>

      <div class="section-header">
        <h3>Selección de Locales Comerciales</h3>
      </div>

      <!-- Plaza -->
      <div class="row">
        <mat-form-field appearance="outline" class="field">
          <mat-label>Plaza de Mercado</mat-label>
          <mat-select formControlName="plazaId">
            <mat-option *ngFor="let p of plazas" [value]="p.id">{{ p.name }}</mat-option>
          </mat-select>
          <mat-hint>Seleccione la plaza donde se encuentran los locales a arrendar</mat-hint>
          <mat-error *ngIf="establishmentFormGroup.get('plazaId')?.hasError('required')">Por favor seleccione la plaza de mercado donde se ubicarán los locales comerciales</mat-error>
        </mat-form-field>
      </div>

      <!-- Establecimientos -->
      <div class="row">
        <mat-form-field appearance="outline" class="field">
          <mat-label>Locales Comerciales</mat-label>
          <mat-select formControlName="establishmentIds" multiple [disabled]="loadingEstablishments || !establishmentFormGroup.get('plazaId')?.value">
            <mat-option *ngFor="let e of filteredEstablishments" [value]="e.id">
              {{ e.name }}
              <span class="establishment-details" *ngIf="e.areaM2 || e.rentValueBase">
                ({{ e.areaM2 ? e.areaM2 + ' m²' : '' }}{{ e.areaM2 && e.rentValueBase ? ' - ' : '' }}{{ e.rentValueBase ? '$' + e.rentValueBase : '' }})
              </span>
            </mat-option>
          </mat-select>
          <mat-hint *ngIf="loadingEstablishments">Cargando locales...</mat-hint>
          <mat-hint *ngIf="!establishmentFormGroup.get('plazaId')?.value">Primero seleccione una plaza de mercado</mat-hint>
          <mat-hint *ngIf="establishmentFormGroup.get('plazaId')?.value && filteredEstablishments.length === 0">No hay locales disponibles en la plaza seleccionada</mat-hint>
          <mat-hint *ngIf="filteredEstablishments.length > 0">Puede seleccionar múltiples locales para el mismo contrato</mat-hint>
          <mat-error *ngIf="establishmentFormGroup.get('establishmentIds')?.hasError('required')">
            Por favor seleccione al menos un local comercial para incluir en el contrato de arrendamiento
          </mat-error>
        </mat-form-field>
      </div>

      <div class="section-header">
        <h3>Cláusulas Adicionales</h3>
      </div>

      <!-- Cláusulas -->
      <div class="row">
        <mat-form-field appearance="outline" class="field">
          <mat-label>Cláusulas Especiales (Opcional)</mat-label>
          <mat-select formControlName="clauseIds" multiple>
            <mat-option *ngFor="let c of clauses" [value]="c.id">{{ c.description }}</mat-option>
          </mat-select>
          <mat-hint>Seleccione las cláusulas especiales que desea incluir en el contrato</mat-hint>
        </mat-form-field>
      </div>

      <div class="actions">
        <app-standard-button
          text="Cancelar"
          variant="stroked"
          (clicked)="cancel()">
        </app-standard-button>
        <app-standard-button
          text="Atrás"
          variant="flat"
          icon="arrow_back"
          (clicked)="stepper.previous()">
        </app-standard-button>
        <app-standard-button
          [text]="saving ? 'Creando…' : 'Crear contrato'"
          variant="raised"
          color="primary"
          icon="save"
          [disabled]="personFormGroup.invalid || contractFormGroup.invalid || establishmentFormGroup.invalid || saving"
          [loading]="saving"
          loadingText="Creando…"
          (clicked)="submit()">
        </app-standard-button>
      </div>
    </form>
  </mat-step>
</mat-stepper>

