<form [formGroup]="form" (ngSubmit)="submit()" class="form">

  <!-- Documento (reactivo) + spinner -->
  <div class="row">
    <mat-form-field appearance="outline" class="field">
      <mat-label>Documento</mat-label>
      <input matInput formControlName="document" />
      <mat-spinner *ngIf="loadingPerson" matSuffix diameter="20"></mat-spinner>
      <mat-error *ngIf="form.get('document')?.hasError('required')">Requerido</mat-error>
      <mat-error *ngIf="form.get('document')?.hasError('minlength')">Mínimo 5 caracteres</mat-error>
    </mat-form-field>
  </div>

  <!-- Aviso persona encontrada -->
  <div *ngIf="personaEncontrada" class="info-ok">
    Persona encontrada (ID {{ personId }}). Se cargaron: nombre, apellidos, teléfono, email, dirección y ciudad.
  </div>

  <!-- Datos persona -->
  <div class="row two-cols">
    <mat-form-field appearance="outline" class="field no-dim">
      <mat-label>Nombres</mat-label>
      <input matInput formControlName="firstName" />
      <mat-error *ngIf="form.get('firstName')?.hasError('required')">Requerido</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="field no-dim">
      <mat-label>Apellidos</mat-label>
      <input matInput formControlName="lastName" />
      <mat-error *ngIf="form.get('lastName')?.hasError('required')">Requerido</mat-error>
    </mat-form-field>
  </div>

  <div class="row two-cols">
    <mat-form-field appearance="outline" class="field no-dim">
      <mat-label>Teléfono</mat-label>
      <input matInput formControlName="phone" />
      <mat-error *ngIf="form.get('phone')?.hasError('required')">Requerido</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="field no-dim">
      <mat-label>Email</mat-label>
      <input matInput formControlName="email" type="email" />
      <mat-error *ngIf="form.get('email')?.hasError('email')">Correo inválido</mat-error>
    </mat-form-field>
  </div>

  <!-- Ubicación -->
  <div class="row two-cols">
    <mat-form-field appearance="outline" class="field no-dim">
      <mat-label>Dirección</mat-label>
      <input matInput formControlName="address" />
      <mat-error *ngIf="form.get('address')?.hasError('required')">Requerida</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="field no-dim">
      <mat-label>Ciudad</mat-label>
      <mat-select formControlName="cityId">
        <mat-option *ngFor="let c of ciudades" [value]="c.id">{{ c.name }}</mat-option>
      </mat-select>
      <mat-hint *ngIf="personaEncontrada && foundCityName">{{ foundCityName }}</mat-hint>
      <mat-error *ngIf="form.get('cityId')?.hasError('required')">Requerida</mat-error>
    </mat-form-field>
  </div>

  <!-- Establecimientos -->
  <div class="row">
    <mat-form-field appearance="outline" class="field">
      <mat-label>Locales (establecimientos)</mat-label>
      <mat-select formControlName="establishmentIds" multiple>
        <mat-option *ngFor="let e of establecimientos" [value]="e.id">
          {{ e.name }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="form.get('establishmentIds')?.hasError('required')">
        Seleccione al menos uno.
      </mat-error>
    </mat-form-field>
  </div>

  <!-- Fechas -->
  <div class="row two-cols">
    <!-- Inicio: readonly, min=max=hoy; el botón abre el calendario -->
    <mat-form-field appearance="outline" class="field no-dim">
      <mat-label>Fecha de Inicio</mat-label>
      <input matInput [matDatepicker]="pickerStart" formControlName="startDate" [min]="startMinDate"
        [max]="startMaxDate" readonly>
      <button mat-icon-button matSuffix type="button" (click)="pickerStart.open()"
        aria-label="Abrir calendario de inicio">
        <mat-icon>event</mat-icon>
      </button>
      <mat-datepicker #pickerStart></mat-datepicker>
      <mat-error *ngIf="form.get('startDate')?.hasError('required')">Requerida</mat-error>
    </mat-form-field>

    <!-- Fin: min = start; el botón abre el calendario -->
    <mat-form-field appearance="outline" class="field">
      <mat-label>Fecha de Fin</mat-label>
      <input matInput [matDatepicker]="pickerEnd" formControlName="endDate" [min]="minEndDate">
      <button mat-icon-button matSuffix type="button" (click)="pickerEnd.open()" aria-label="Abrir calendario de fin">
        <mat-icon>event</mat-icon>
      </button>
      <mat-datepicker #pickerEnd></mat-datepicker>

      <mat-error *ngIf="form.hasError('endBeforeStart')">
        La fecha de fin no puede ser menor que la fecha de inicio.
      </mat-error>
      <mat-error *ngIf="form.get('endDate')?.hasError('required')">
        Requerida.
      </mat-error>
    </mat-form-field>
  </div>

  <!-- Acciones -->
  <div class="actions">
    <button mat-stroked-button type="button" (click)="cancel()">Cancelar</button>
    <button mat-flat-button color="primary" type="submit" [disabled]="form.invalid || saving">
      {{ saving ? 'Creando…' : 'Crear contrato' }}
    </button>
  </div>
</form>