<mat-horizontal-stepper [linear]="true" #stepper class="form-stepper">

<!-- Paso 1: Datos del establecimiento -->
<mat-step [stepControl]="generalGroup">
  <form [formGroup]="generalGroup" autocomplete="off" spellcheck="false" class="form-step">
    <ng-template matStepLabel>Datos del Local</ng-template>

    <div class="section-header">
      <h3>Información Básica del Local</h3>
    </div>

    <!-- Grid responsivo 2 columnas -->
    <div class="form-grid two-cols">
      <!-- Nombre (ancho completo) -->
      <mat-form-field appearance="outline" class="col-span-2">
        <mat-label>Nombre</mat-label>
        <input
          matInput
          formControlName="name"
          required
          placeholder="Local 15 - Carnicería El Buen Sabor"
          (blur)="onTrim(generalGroup.get('name'))"
          autocomplete="off"
        />
        <mat-hint align="start">{{ generalGroup.get('name')?.value?.length || 0 }}/100</mat-hint>
        <mat-error *ngIf="generalGroup.get('name')?.touched && generalGroup.get('name')?.errors as e">
          <ng-container *ngIf="e['required']">Por favor ingrese el nombre del establecimiento</ng-container>
          <ng-container *ngIf="e['maxlength']">El nombre no puede exceder 100 caracteres</ng-container>
          <ng-container *ngIf="e['onlySpaces']">El nombre no puede estar vacío o contener solo espacios</ng-container>
        </mat-error>
      </mat-form-field>

      <!-- Área (ancho completo, debajo del nombre) -->
      <mat-form-field appearance="outline" class="col-span-2">
        <mat-label>Área (m²)</mat-label>
        <input
          matInput
          type="number"
          appNoSci
          inputmode="decimal"
          step="0.01"
          min="1"
          formControlName="areaM2"
          required
          placeholder="25.50"
          (blur)="onNumberBlur(generalGroup.get('areaM2'))"
          autocomplete="off"
        />
        <mat-hint align="end">Máx. 2 decimales · [1 – 1.000.000]</mat-hint>
        <mat-error *ngIf="generalGroup.get('areaM2')?.touched && generalGroup.get('areaM2')?.errors as e">
          <ng-container *ngIf="e['required']">Por favor ingrese el área en metros cuadrados</ng-container>
          <ng-container *ngIf="e['NaN']">El área debe ser un número válido</ng-container>
          <ng-container *ngIf="e['invalidNotation']">Ingrese un número válido sin notación científica</ng-container>
          <ng-container *ngIf="e['min']">El área debe ser mayor a 0 metros cuadrados</ng-container>
          <ng-container *ngIf="e['max']">El área no puede exceder 10,000 metros cuadrados</ng-container>
          <ng-container *ngIf="e['decimalScale']">El área puede tener máximo 2 decimales</ng-container>
        </mat-error>
      </mat-form-field>

      <!-- Valor base (izquierda) -->


      <mat-form-field appearance="outline" class="field-currency">
        <mat-label>Valor base de arriendo</mat-label>
        <input
          matInput
          type="text"
          appNoSci
          inputmode="decimal"
          step="0.01"
          min="1"
          formControlName="rentValueBase"
          appThousandSeparator
          [appThousandSeparatorMax]="12"
          required
          placeholder="850000"
          autocomplete="off"
        />
        <mat-hint align="end">Máx. 2 decimales · ≥ 0.000</mat-hint>
        <mat-error *ngIf="generalGroup.get('rentValueBase')?.touched && generalGroup.get('rentValueBase')?.errors as e">
          <ng-container *ngIf="e['required']">Por favor ingrese el valor base del arriendo</ng-container>
          <ng-container *ngIf="e['NaN'] || e['nan'] || e['numberInvalid']">El valor debe ser un número válido</ng-container>
          <ng-container *ngIf="e['invalidNotation']">Ingrese un número válido sin notación científica</ng-container>
          <ng-container *ngIf="e['min']">El valor base debe ser mayor o igual a $10.000</ng-container>
          <ng-container *ngIf="e['max']">El valor base no puede exceder $999,999,999</ng-container>
          <ng-container *ngIf="e['decimalScale']">El valor puede tener máximo 2 decimales</ng-container>
        </mat-error>
      </mat-form-field>

      <!-- UVT (derecha) -->
      <mat-form-field appearance="outline">
        <mat-label>UVT</mat-label>
        <input
          matInput
          type="number"
          appNoSci
          inputmode="decimal"
          step="0.01"
          min="1"
          formControlName="uvtQty"
          required
          placeholder="2.5"
          (blur)="onNumberBlur(generalGroup.get('uvtQty'))"
          autocomplete="off"
        />
        <mat-hint align="end">Máx. 2 decimales · [1 – 9.999]</mat-hint>
        <mat-error *ngIf="generalGroup.get('uvtQty')?.touched && generalGroup.get('uvtQty')?.errors as e">
          <ng-container *ngIf="e['required']">Por favor ingrese la cantidad de UVT</ng-container>
          <ng-container *ngIf="e['NaN']">La cantidad de UVT debe ser un número válido</ng-container>
          <ng-container *ngIf="e['invalidNotation']">Ingrese un número válido sin notación científica</ng-container>
          <ng-container *ngIf="e['min']">La cantidad de UVT debe ser mayor a 0</ng-container>
          <ng-container *ngIf="e['max']">La cantidad de UVT no puede exceder 999</ng-container>
          <ng-container *ngIf="e['decimalScale']">La cantidad de UVT puede tener máximo 2 decimales</ng-container>
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Descripción (ancho completo) -->
    <mat-form-field appearance="outline" class="mt-2 w-100">
      <mat-label>Descripción</mat-label>
      <textarea
        matInput
        rows="3"
        formControlName="description"
        required
        placeholder="Local comercial ubicado en el primer piso, ideal para carnicería o venta de alimentos. Cuenta con mesón en acero inoxidable y sistema de refrigeración."
        (blur)="onTrim(generalGroup.get('description'))"
      ></textarea>
      <mat-hint align="start">{{ generalGroup.get('description')?.value?.length || 0 }}/500</mat-hint>
      <mat-error *ngIf="generalGroup.get('description')?.touched && generalGroup.get('description')?.errors as e">
        <ng-container *ngIf="e['required']">Por favor ingrese una descripción del establecimiento</ng-container>
        <ng-container *ngIf="e['maxlength']">La descripción no puede exceder 500 caracteres</ng-container>
        <ng-container *ngIf="e['onlySpaces']">La descripción no puede estar vacía o contener solo espacios</ng-container>
      </mat-error>
    </mat-form-field>

    <div class="form-actions">
      <app-standard-button
        text="Cancelar"
        variant="stroked"
        (clicked)="cancel()"
        [disabled]="isBusy">
      </app-standard-button>
      <app-standard-button
        text="Siguiente"
        variant="raised"
        color="primary"
        icon="arrow_forward"
        iconPosition="right"
        (clicked)="stepper.next()"
        [disabled]="generalGroup.invalid || isBusy">
      </app-standard-button>
    </div>
  </form>
</mat-step>



  <!-- Paso 2: Ubicación -->
  <mat-step [stepControl]="ubicacionGroup">
    <form [formGroup]="ubicacionGroup" autocomplete="off" spellcheck="false" class="form-step">
      <ng-template matStepLabel>Ubicación</ng-template>

      <div class="section-header">
        <h3>Ubicación del Local</h3>
      </div>

      <!-- Plaza -->
      <mat-form-field appearance="outline" class="w-100 mb-3">
        <mat-label>Plaza*</mat-label>
        <mat-select formControlName="plazaId" required>
          <mat-option *ngFor="let plaza of Squares; trackBy: trackByIndex" [value]="plaza.id">
            {{ plaza.name }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="ubicacionGroup.get('plazaId')?.touched && ubicacionGroup.get('plazaId')?.errors as e">
          <ng-container *ngIf="e['required']">Por favor seleccione la plaza de mercado donde se ubicará el local comercial</ng-container>
        </mat-error>
      </mat-form-field>

      <!-- Dirección -->
      <mat-form-field appearance="outline" class="w-100 mb-3">
        <mat-label>Dirección</mat-label>
        <input
          matInput
          formControlName="address"
          placeholder="Carrera 7 # 14 - 28 Local 15"
          (blur)="onTrim(ubicacionGroup.get('address'))"
          autocomplete="off"
        />
        <mat-error *ngIf="ubicacionGroup.get('address')?.touched && ubicacionGroup.get('address')?.errors as e">
          <ng-container *ngIf="e['required']">La dirección es obligatoria</ng-container>
          <ng-container *ngIf="e['maxlength']">La dirección no puede exceder 150 caracteres</ng-container>
          <ng-container *ngIf="e['addressInvalid']">Por favor ingrese una dirección válida</ng-container>
          <ng-container *ngIf="e['onlySpaces']">La dirección no puede ser solo espacios</ng-container>
        </mat-error>
      </mat-form-field>

      <div class="form-actions space-between">
        <div>
          <app-standard-button
            text="Cancelar"
            variant="stroked"
            (clicked)="cancel()"
            [disabled]="isBusy">
          </app-standard-button>
          <app-standard-button
            text="Anterior"
            variant="flat"
            icon="arrow_back"
            iconPosition="left"
            (clicked)="stepper.previous()"
            [disabled]="isBusy"
            class="ms-2">
          </app-standard-button>
        </div>
        <app-standard-button
          text="Siguiente"
          variant="raised"
          color="primary"
          icon="arrow_forward"
          iconPosition="right"
          (clicked)="stepper.next()"
          [disabled]="ubicacionGroup.invalid || isBusy">
        </app-standard-button>
      </div>
    </form>
  </mat-step>

  <!-- Paso 3: Imágenes -->
  <mat-step>
    <ng-template matStepLabel>Imágenes</ng-template>
    <div class="form-step">

    <div class="section-header">
      <h3>Imágenes del Local</h3>
    </div>

    <!-- Dropzone usando la directiva -->
    <div
      appFileDrop
      (files)="onFilesAdded($event)"
      class="dropzone mb-3"
      [class.dropzone--disabled]="isBusy"
      role="button"
      tabindex="0"
      (keydown.enter)="fileInput.click()"
      (keydown.space)="fileInput.click()"
      (click)="fileInput.click()"
    >
      <mat-icon>cloud_upload</mat-icon>
      <p>Arrastra imágenes aquí o haz clic para seleccionarlas</p>
      <small>Formatos soportados: JPG, PNG, WEBP (Máx. {{ MAX_IMAGES }} imágenes · {{ MAX_FILE_SIZE_MB }} MB c/u)</small>
      <input type="file" #fileInput (change)="handleFileInput($event)" accept="image/jpeg,image/png,image/webp" multiple hidden />
    </div>

    <div class="image-counter mt-2 mb-3">
      <span class="counter-badge">
        {{ selectedFiles.length + existingImagesFull.length }}/{{ MAX_IMAGES }} imágenes
      </span>
    </div>

    <div class="compact-image-grid">
      <!-- Existentes -->
      <div
        class="compact-image-container"
        *ngFor="let img of existingImagesFull; let i = index; trackBy: trackByIndex"
        (dragstart)="$event.preventDefault()"
        (click)="openPreviewFromExisting(i)"
        role="button"
        tabindex="0"
        (keydown.enter)="openPreviewFromExisting(i)"
        (keydown.space)="openPreviewFromExisting(i)"
      >
        <img [src]="imgSrc(img)" alt="Imagen existente" class="compact-image" draggable="false" />
        <div class="compact-image-actions">
          <button
            mat-icon-button
            color="warn"
            (click)="$event.stopPropagation(); removeImage(i, true)"
            matTooltip="Eliminar"
            [disabled]="isBusy"
          >
            <mat-icon class="compact-icon">delete</mat-icon>
          </button>
        </div>
        <span class="compact-image-label">Existente</span>
      </div>

      <!-- Nuevas -->
      <div
        class="compact-image-container"
        *ngFor="let imgPath of imagesPreview; let i = index; trackBy: trackByIndex"
        (dragstart)="$event.preventDefault()"
        (click)="openPreviewFromNew(i)"
        role="button"
        tabindex="0"
        (keydown.enter)="openPreviewFromNew(i)"
        (keydown.space)="openPreviewFromNew(i)"
      >
        <img [src]="imgPath" alt="Vista previa" class="compact-image" draggable="false" />
        <div class="compact-image-actions">
          <button
            mat-icon-button
            color="warn"
            (click)="$event.stopPropagation(); removeImage(i, false)"
            matTooltip="Eliminar"
            [disabled]="isBusy"
          >
            <mat-icon class="compact-icon">delete</mat-icon>
          </button>
        </div>
        <span class="compact-image-label">Nueva</span>
      </div>
    </div>

    <div class="form-actions space-between">
      <div>
        <app-standard-button
          text="Cancelar"
          variant="stroked"
          (clicked)="cancel()"
          [disabled]="isBusy">
        </app-standard-button>
        <app-standard-button
          text="Anterior"
          variant="flat"
          icon="arrow_back"
          iconPosition="left"
          (clicked)="stepper.previous()"
          [disabled]="isBusy"
          class="ms-2">
        </app-standard-button>
      </div>

      <app-standard-button
        [text]="isEdit ? 'Actualizar' : 'Crear'"
        variant="raised"
        color="primary"
        icon="save"
        iconPosition="left"
        [loading]="isBusy"
        loadingText="Guardando..."
        (clicked)="onSubmit()"
        [disabled]="isBusy"
        class="btn-progress">
      </app-standard-button>
    </div>
    </div>
  </mat-step>
</mat-horizontal-stepper>
